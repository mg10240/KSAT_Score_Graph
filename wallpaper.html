<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>iPad ì„±ì  ê·¸ë˜í”„ Wallpaper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      background: #fff;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      text-align: center;
      color: #333;
      padding: 2em;
    }
    h1 {
      margin-bottom: 1.2em;
      font-size: 2em;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.7em;
      margin-bottom: 1em;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5em;
      background: #f4f6f8;
      padding: 0.5em 1em;
      border-radius: 10px;
    }
    canvas {
      display: block;
      margin: 1.5em auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    button, label input[type="file"] {
      display: inline-block;
      padding: 0.6em 1.4em;
      background: #91bfff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #7aaee8;
    }
    input[type="file"], input[type="color"], input[type="checkbox"] {
      margin-left: 0.5em;
    }
  </style>
</head>
<body>

<h1>iPad Wallpaperìš© ì„±ì  ê·¸ë˜í”„</h1>

<div class="controls">
  <label>ğŸ“ JSON ë¶ˆëŸ¬ì˜¤ê¸°<input type="file" id="uploadJson" accept=".json"></label>
  <button onclick="downloadWallpaper()">ğŸ’¾ ë°°ê²½í™”ë©´ ì €ì¥</button>
</div>

<div id="options"></div>

<canvas id="wallpaperChart" width="2732" height="2048"></canvas>

<script>
let chart, chartData;
let colorPalette = ['#A5C8FF', '#FFCFD2', '#C0F2DC', '#FFE7A3', '#D8C4FF']; // íŒŒìŠ¤í…”í†¤

function recreateCanvas() {
  const oldCanvas = document.getElementById('wallpaperChart');
  oldCanvas.remove();
  const newCanvas = document.createElement('canvas');
  newCanvas.id = 'wallpaperChart';
  newCanvas.width = 2732;
  newCanvas.height = 2048;
  document.body.appendChild(newCanvas);
  return newCanvas.getContext('2d');
}

function createFadeOutMask(ctx, width, height) {
  const gradient = ctx.createLinearGradient(0, 0, width, 0);
  gradient.addColorStop(0, 'rgba(255,255,255,1)');
  gradient.addColorStop(0.05, 'rgba(255,255,255,0)');
  gradient.addColorStop(0.95, 'rgba(255,255,255,0)');
  gradient.addColorStop(1, 'rgba(255,255,255,1)');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);
}

function applyValueAdjustment(data) {
  const minDiff = 0.5;
  data.forEach(ds => {
    const adjusted = ds.data.map((v, i, arr) => {
      if (i === 0) return v;
      const diff = Math.abs(v - arr[i-1]);
      if (diff < minDiff) return v + (v >= 0 ? minDiff : -minDiff);
      return v;
    });
    ds.data = adjusted;
  });
}

function loadChartFromData(rawData) {
  chartData = JSON.parse(JSON.stringify(rawData));
  applyValueAdjustment(chartData.datasets);
  const ctx = recreateCanvas();
  if (chart) chart.destroy();

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';

  chartData.datasets.forEach((ds, idx) => {
    const color = colorPalette[idx % colorPalette.length];

    const group = document.createElement('div');
    group.className = 'checkbox-group';

    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = true;
    chk.dataset.index = idx;
    chk.className = 'dataset-toggle';
    chk.onchange = updateChart;

    const lbl = document.createElement('label');
    lbl.textContent = ds.label;

    group.appendChild(chk);
    group.appendChild(lbl);

    optionsDiv.appendChild(group);
  });

  // ê·¸ë˜í”„ ë¼ì¸ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
  const lineToggleGroup = document.createElement('div');
  lineToggleGroup.className = 'checkbox-group';
  const lineToggle = document.createElement('input');
  lineToggle.type = 'checkbox';
  lineToggle.checked = true;
  lineToggle.id = 'lineToggle';
  lineToggle.onchange = updateChart;

  const lineLabel = document.createElement('label');
  lineLabel.textContent = 'ê·¸ë˜í”„ ë¼ì¸ í‘œì‹œ';

  lineToggleGroup.appendChild(lineToggle);
  lineToggleGroup.appendChild(lineLabel);
  optionsDiv.appendChild(lineToggleGroup);

  updateChart();
}

function updateChart() {
  const ctx = document.getElementById('wallpaperChart').getContext('2d');
  if (chart) chart.destroy();

  const showLine = document.getElementById('lineToggle')?.checked ?? true;

  const activeDatasets = chartData.datasets.map((ds, idx) => {
    const visible = document.querySelector(`input.dataset-toggle[data-index="${idx}"]`).checked;
    if (!visible) return null;

    const gradient = ctx.createLinearGradient(0, 1740, 0, 2048); // í•˜ë‹¨ 14% ì •ë„ë§Œ
    gradient.addColorStop(0, colorPalette[idx] + '66'); // 40% íˆ¬ëª…
    gradient.addColorStop(1, 'rgba(255,255,255,0)');

    return {
      label: ds.label,
      data: ds.data,
      borderColor: colorPalette[idx],
      backgroundColor: gradient,
      borderWidth: 3,
      tension: 0.5,
      fill: true,
      pointRadius: 0,
      showLine: showLine
    };
  }).filter(Boolean);

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartData.labels,
      datasets: activeDatasets
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      },
      scales: {
        x: { display: false },
        y: {
          display: false,
          min: Math.min(...chartData.datasets.flatMap(ds => ds.data)) - 5,
          max: Math.max(...chartData.datasets.flatMap(ds => ds.data)) + 5
        }
      },
      elements: {
        line: { borderCapStyle: 'round' }
      }
    },
    plugins: [{
      id: 'fadeMask',
      afterDraw: (chart) => {
        const { ctx, width, height } = chart;
        createFadeOutMask(ctx, width, height);
      }
    }]
  });
}

function downloadWallpaper() {
  const link = document.createElement('a');
  link.href = document.getElementById('wallpaperChart').toDataURL('image/png');
  link.download = 'ipad_wallpaper.png';
  link.click();
}

document.getElementById('uploadJson').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => loadChartFromData(JSON.parse(evt.target.result));
  reader.readAsText(file);
});
</script>

</body>
</html>
