<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>iPad Wallpaper Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      background: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      color: #333;
    }
    h1 {
      margin: 1em 0;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: linear-gradient(to bottom, #ffffff, #f4f6f8 60%, #e8ecf0 100%);
    }
    .button-group, .color-controls {
      margin: 1em 0.5em;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5em;
    }
    button, label {
      padding: 0.6em 1.2em;
      background: #91bfff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover, label:hover {
      background: #7aaee8;
    }
    input[type="file"], input[type="color"] {
      display: inline-block;
    }
    .toggle {
      display: flex;
      align-items: center;
      gap: 0.4em;
    }
  </style>
</head>
<body>

<h1>iPad 배경화면용 성적 그래프</h1>

<div class="button-group">
  <label for="uploadJson">📁 JSON 불러오기</label>
  <input type="file" id="uploadJson" accept=".json" />
  <button onclick="downloadWallpaper()">💾 배경화면 저장</button>
</div>

<div id="colorControls" class="color-controls"></div>

<canvas id="wallpaperChart" width="2732" height="2048"></canvas>

<script>
let chart;
let chartDataRaw;
const colorPalette = ['#8b73ff', '#ffa8dc', '#91bfff', '#ffb347', '#7ed6df', '#f78fb3', '#c8e6c9'];

function recreateCanvas() {
  const oldCanvas = document.getElementById('wallpaperChart');
  if (oldCanvas) oldCanvas.remove();
  const newCanvas = document.createElement('canvas');
  newCanvas.id = 'wallpaperChart';
  newCanvas.width = 2732;
  newCanvas.height = 2048;
  document.body.appendChild(newCanvas);
  return newCanvas.getContext('2d');
}

function createGradient(ctx, height, color) {
  const gradient = ctx.createLinearGradient(0, 1600, 0, 2048);
  gradient.addColorStop(0, color + '22');
  gradient.addColorStop(1, 'rgba(255,255,255,0)');
  return gradient;
}

function createFadeOutMask(ctx, width, height) {
  const gradient = ctx.createLinearGradient(0, 0, width, 0);
  gradient.addColorStop(0, 'rgba(255,255,255,1)');
  gradient.addColorStop(0.03, 'rgba(255,255,255,0)');
  gradient.addColorStop(0.97, 'rgba(255,255,255,0)');
  gradient.addColorStop(1, 'rgba(255,255,255,1)');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);
}

function buildColorControls(datasets) {
  const controlDiv = document.getElementById('colorControls');
  controlDiv.innerHTML = '';
  datasets.forEach((ds, idx) => {
    const control = document.createElement('div');
    control.className = 'toggle';
    control.innerHTML = `
      <input type="color" value="${ds.borderColor}" id="color${idx}">
      <label>${ds.label}</label>
      <input type="checkbox" id="toggle${idx}" checked>
    `;
    controlDiv.appendChild(control);

    document.getElementById(`color${idx}`).addEventListener('input', () => updateChartColors());
    document.getElementById(`toggle${idx}`).addEventListener('change', () => updateChartColors());
  });
}

function loadChartFromData(data) {
  chartDataRaw = data;
  const ctx = recreateCanvas();
  if (chart) chart.destroy();

  const values = data.datasets.flatMap(ds => ds.data);
  const minVal = Math.min(...values);
  const maxVal = Math.max(...values);
  const buffer = Math.max(5, (maxVal - minVal) < 10 ? 10 : 0);

  data.datasets.forEach((ds, i) => {
    ds.borderColor = colorPalette[i % colorPalette.length];
    ds.fill = false;
    ds.borderWidth = 3;
    ds.tension = 0.4;
    ds.pointRadius = 0;
  });

  buildColorControls(data.datasets);

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: data.datasets
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: {
        x: { display: false },
        y: { display: false, min: minVal - buffer, max: maxVal + buffer }
      },
      layout: { padding: { top: 1500 } },
      elements: { line: { borderCapStyle: 'round' } }
    },
    plugins: [{
      id: 'customBG',
      beforeDraw: (chart) => {
        const { ctx, chartArea } = chart;
        ctx.save();
        chart.data.datasets.forEach((ds, i) => {
          if (document.getElementById(`toggle${i}`).checked) {
            const grad = createGradient(ctx, 2048, ds.borderColor);
            ctx.fillStyle = grad;
            ctx.fillRect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom);
          }
        });
        ctx.restore();
      },
      afterDraw: (chart) => {
        const { ctx, width, height } = chart;
        createFadeOutMask(ctx, width, height);
      }
    }]
  });
}

function updateChartColors() {
  chartDataRaw.datasets.forEach((ds, i) => {
    const color = document.getElementById(`color${i}`).value;
    ds.borderColor = color;
    chart.data.datasets[i].hidden = !document.getElementById(`toggle${i}`).checked;
    chart.data.datasets[i].borderColor = color;
  });
  chart.update();
}

function downloadWallpaper() {
  const link = document.createElement('a');
  link.href = document.getElementById('wallpaperChart').toDataURL('image/png');
  link.download = 'ipad_wallpaper.png';
  link.click();
}

document.getElementById('uploadJson').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (evt) {
    const data = JSON.parse(evt.target.result);
    localStorage.setItem('wallpaperData', JSON.stringify(data));
    loadChartFromData(data);
  };
  reader.readAsText(file);
});

window.onload = () => {
  const savedData = localStorage.getItem('wallpaperData');
  if (savedData) loadChartFromData(JSON.parse(savedData));
};
</script>

</body>
</html>
